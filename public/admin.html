<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alpha Surfaces ‚Äî Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#111110;--surface:#1a1a18;--surface2:#222220;--border:#2a2a28;--text:#e8e6e0;--text2:#9c9890;--olive:#5C5A1E;--gold:#B8A472;--red:#c0392b;--green:#27ae60}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* Login */
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px}
.login-box{background:var(--surface);border:1px solid var(--border);padding:48px;max-width:380px;width:100%}
.login-box h1{font-size:1.4rem;font-weight:600;margin-bottom:6px}
.login-box p{font-size:.82rem;color:var(--text2);margin-bottom:28px}
.login-box input{width:100%;padding:12px 16px;background:var(--bg);border:1px solid var(--border);color:var(--text);font-size:.88rem;font-family:inherit;margin-bottom:16px;outline:none;transition:border .3s}
.login-box input:focus{border-color:var(--gold)}
.login-box button{width:100%;padding:12px;background:var(--olive);color:#fff;border:none;font-size:.82rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:background .3s}
.login-box button:hover{background:var(--gold)}
.login-error{color:var(--red);font-size:.78rem;margin-bottom:12px;display:none}

/* Layout */
.admin-layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
.sidebar{background:var(--surface);border-right:1px solid var(--border);padding:24px 0;position:sticky;top:0;height:100vh;overflow-y:auto}
.sidebar-brand{padding:0 20px 24px;border-bottom:1px solid var(--border);margin-bottom:16px}
.sidebar-brand h2{font-size:1.1rem;font-weight:600;color:var(--text)}
.sidebar-brand span{font-size:.65rem;color:var(--gold);letter-spacing:.15em;text-transform:uppercase}
.sidebar-nav a{display:flex;align-items:center;gap:10px;padding:10px 20px;color:var(--text2);text-decoration:none;font-size:.82rem;font-weight:400;transition:all .2s;border-left:2px solid transparent}
.sidebar-nav a:hover,.sidebar-nav a.active{color:var(--text);background:rgba(255,255,255,.03);border-left-color:var(--gold)}
.sidebar-nav .divider{height:1px;background:var(--border);margin:12px 20px}
.sidebar-bottom{position:absolute;bottom:0;left:0;right:0;padding:16px 20px;border-top:1px solid var(--border)}
.sidebar-bottom a{color:var(--text2);text-decoration:none;font-size:.78rem;transition:color .2s}
.sidebar-bottom a:hover{color:var(--red)}

.main{padding:32px 40px;overflow-y:auto}
.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;padding-bottom:20px;border-bottom:1px solid var(--border)}
.main-header h1{font-size:1.3rem;font-weight:600}
.save-bar{display:flex;gap:10px;align-items:center}
.save-msg{font-size:.75rem;color:var(--green);opacity:0;transition:opacity .3s}
.save-msg.show{opacity:1}
.btn{padding:10px 24px;border:none;font-size:.78rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:all .3s;font-family:inherit}
.btn-save{background:var(--olive);color:#fff}
.btn-save:hover{background:var(--gold)}
.btn-preview{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-preview:hover{border-color:var(--gold);color:var(--gold)}

/* Panels */
.panel{display:none}
.panel.active{display:block}

/* Form elements */
.field{margin-bottom:20px}
.field label{display:block;font-size:.72rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text2);margin-bottom:6px}
.field input[type="text"],.field input[type="color"],.field textarea,.field select{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);color:var(--text);font-size:.85rem;font-family:inherit;outline:none;transition:border .3s;resize:vertical}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--gold)}
.field textarea{min-height:80px}
.field input[type="color"]{height:42px;padding:4px;cursor:pointer}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.field-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.card{background:var(--surface);border:1px solid var(--border);padding:20px;margin-bottom:16px;position:relative}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.card-header h3{font-size:.88rem;font-weight:600}
.card-actions{display:flex;gap:8px}
.btn-sm{padding:5px 12px;font-size:.68rem;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;transition:all .2s;font-family:inherit}
.btn-sm:hover{border-color:var(--gold);color:var(--gold)}
.btn-sm.danger:hover{border-color:var(--red);color:var(--red)}
.btn-add{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:transparent;border:1px dashed var(--border);color:var(--text2);font-size:.78rem;cursor:pointer;transition:all .2s;font-family:inherit;margin-top:8px}
.btn-add:hover{border-color:var(--gold);color:var(--gold)}

/* Toggle */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
.toggle-row span{font-size:.85rem}
.toggle{width:42px;height:24px;background:var(--border);border-radius:12px;position:relative;cursor:pointer;transition:background .3s}
.toggle.on{background:var(--olive)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .3s}
.toggle.on::after{transform:translateX(18px)}

/* Section order */
.order-list{list-style:none}
.order-item{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);margin-bottom:4px;cursor:grab;transition:all .2s}
.order-item:hover{border-color:var(--gold)}
.order-item .grip{color:var(--text2);font-size:1rem;user-select:none}
.order-item .name{font-size:.85rem;flex:1}
.hidden{display:none}

/* ‚îÄ‚îÄ‚îÄ AI Panel ‚îÄ‚îÄ‚îÄ */
.ai-trigger{display:flex;align-items:center;gap:8px;padding:10px 20px;color:var(--gold);text-decoration:none;font-size:.82rem;font-weight:500;cursor:pointer;border-left:2px solid transparent;transition:all .2s;background:none;border-top:none;border-right:none;border-bottom:none;width:100%;font-family:inherit}
.ai-trigger:hover{background:rgba(184,164,114,.08);border-left-color:var(--gold)}
.ai-trigger .pulse{width:8px;height:8px;background:var(--gold);border-radius:50%;animation:aiPulse 2s infinite}
@keyframes aiPulse{0%,100%{opacity:1}50%{opacity:.3}}

.ai-panel{position:fixed;top:0;right:-500px;width:480px;height:100vh;background:var(--bg);border-left:1px solid var(--border);z-index:1000;display:flex;flex-direction:column;transition:right .35s cubic-bezier(.4,0,.2,1);box-shadow:-8px 0 32px rgba(0,0,0,.5)}
.ai-panel.open{right:0}
.ai-panel.fullscreen{width:100vw;right:-100vw}
.ai-panel.fullscreen.open{right:0}

.ai-panel-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--surface)}
.ai-panel-header h3{font-size:.88rem;font-weight:600;color:var(--text);display:flex;align-items:center;gap:8px}
.ai-panel-header h3 .ai-icon{color:var(--gold);font-size:1rem}
.ai-header-actions{display:flex;gap:4px}
.ai-header-btn{background:none;border:1px solid var(--border);color:var(--text2);width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.85rem;transition:all .2s}
.ai-header-btn:hover{border-color:var(--gold);color:var(--gold)}

.ai-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth}

/* Empty state */
.ai-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px 32px}
.ai-empty .icon{font-size:1.5rem;color:var(--gold);margin-bottom:16px}
.ai-empty h4{font-size:1rem;font-weight:600;margin-bottom:8px;color:var(--text)}
.ai-empty p{font-size:.82rem;color:var(--text2);line-height:1.6;max-width:320px;margin-bottom:24px}
.ai-prompts{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;max-width:380px}
.ai-prompt-pill{padding:6px 14px;background:var(--surface);border:1px solid var(--border);color:var(--text2);font-size:.72rem;cursor:pointer;transition:all .2s;font-family:inherit}
.ai-prompt-pill:hover{border-color:var(--gold);color:var(--gold)}

/* User messages */
.ai-msg{max-width:92%}
.ai-msg-user{align-self:flex-end}
.ai-msg-user .ai-bubble{background:rgba(92,90,30,.4);border:1px solid rgba(184,164,114,.3);padding:12px 16px;color:#F7F5F0;font-size:.84rem;line-height:1.6}
.ai-msg-user .ai-time{text-align:right;font-size:.68rem;color:var(--text2);margin-top:4px}
.ai-msg-user .ai-bubble img.ai-attachment-thumb{max-width:200px;max-height:120px;border:1px solid var(--border);margin-bottom:8px;display:block}

/* Assistant messages */
.ai-msg-assistant{align-self:flex-start}
.ai-msg-assistant .ai-label{font-size:.68rem;color:var(--gold);letter-spacing:.08em;text-transform:uppercase;margin-bottom:4px;font-weight:600}
.ai-msg-assistant .ai-bubble{padding:2px 0;color:var(--text);font-size:.84rem;line-height:1.7}
.ai-msg-assistant .ai-bubble p{margin-bottom:8px}
.ai-msg-assistant .ai-bubble p:last-child{margin-bottom:0}
.ai-msg-assistant .ai-bubble strong{color:#fff}
.ai-msg-assistant .ai-bubble em{color:var(--gold);font-style:italic}
.ai-msg-assistant .ai-bubble code{background:var(--surface);padding:2px 6px;font-size:.78rem;color:var(--gold)}
.ai-msg-assistant .ai-bubble ul,.ai-msg-assistant .ai-bubble ol{padding-left:20px;margin-bottom:8px}
.ai-msg-assistant .ai-bubble li{margin-bottom:4px}
.ai-msg-assistant .ai-time{font-size:.68rem;color:var(--text2);margin-top:4px}

/* System messages */
.ai-msg-system{align-self:center;text-align:center;padding:8px 0}
.ai-msg-system::before,.ai-msg-system::after{content:'';display:block;height:1px;background:var(--border);margin:8px auto;width:60px}
.ai-msg-system span{font-size:.72rem;color:var(--text2)}

/* Typing indicator */
.ai-typing{align-self:flex-start;display:flex;align-items:center;gap:8px;padding:4px 0}
.ai-typing .ai-label{font-size:.68rem;color:var(--gold);letter-spacing:.08em;text-transform:uppercase;font-weight:600}
.ai-typing-dots{display:flex;gap:4px;align-items:center}
.ai-typing-dots span{width:6px;height:6px;background:var(--text2);border-radius:50%;animation:typingBounce 1.4s infinite both}
.ai-typing-dots span:nth-child(2){animation-delay:.2s}
.ai-typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes typingBounce{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}

/* Diff card */
.ai-diff-card{background:#1A1A18;border:1px solid rgba(184,164,114,.2);padding:16px;margin-top:12px}
.ai-diff-card.collapsed{padding:10px 16px}
.ai-diff-header{font-size:.72rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text2);margin-bottom:12px;display:flex;align-items:center;gap:6px}
.ai-diff-header::before{content:'';width:12px;height:1px;background:var(--gold)}
.ai-diff-field{margin-bottom:12px}
.ai-diff-field:last-of-type{margin-bottom:16px}
.ai-diff-field-name{font-size:.76rem;color:var(--gold);font-weight:500;margin-bottom:4px}
.ai-diff-remove{color:#ff6b6b;font-size:.8rem;text-decoration:line-through;padding:2px 0;word-break:break-word}
.ai-diff-add{color:#69db7c;font-size:.8rem;padding:2px 0;word-break:break-word}
.ai-diff-actions{display:flex;gap:10px;margin-top:14px}
.ai-diff-apply{padding:8px 20px;background:var(--gold);color:#111;font-size:.75rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;border:none;cursor:pointer;font-family:inherit;transition:all .2s}
.ai-diff-apply:hover{background:#cbb87f}
.ai-diff-discard{padding:8px 20px;background:transparent;color:var(--text2);font-size:.75rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;border:1px solid var(--border);cursor:pointer;font-family:inherit;transition:all .2s}
.ai-diff-discard:hover{border-color:var(--text2);color:var(--text)}
.ai-diff-applied{font-size:.78rem;color:var(--green);font-weight:500;display:flex;align-items:center;gap:6px}
.ai-diff-undo-link{font-size:.72rem;color:var(--text2);cursor:pointer;margin-top:6px;display:inline-block;transition:color .2s}
.ai-diff-undo-link:hover{color:var(--gold)}

/* Input bar */
.ai-input-area{border-top:1px solid var(--border);flex-shrink:0;background:var(--surface)}
.ai-attachments-preview{display:flex;gap:8px;padding:8px 16px 0;flex-wrap:wrap}
.ai-attachment-item{position:relative;background:var(--bg);border:1px solid var(--border);padding:4px;display:flex;align-items:center;gap:6px}
.ai-attachment-item img{width:48px;height:48px;object-fit:cover}
.ai-attachment-item .ai-att-name{font-size:.7rem;color:var(--text2);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ai-attachment-item .ai-att-remove{position:absolute;top:-6px;right:-6px;width:18px;height:18px;background:var(--red);color:#fff;border:none;font-size:.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:50%}
.ai-input-row{display:flex;align-items:flex-end;gap:8px;padding:12px 16px}
.ai-attach-btn{background:none;border:none;color:var(--text2);font-size:1.1rem;cursor:pointer;padding:8px;transition:color .2s;flex-shrink:0}
.ai-attach-btn:hover{color:var(--gold)}
.ai-input{flex:1;background:#1A1A18;border:1px solid rgba(255,255,255,.1);color:var(--text);font-size:.84rem;font-family:inherit;padding:10px 14px;outline:none;resize:none;max-height:120px;min-height:40px;line-height:1.5;transition:border .3s}
.ai-input:focus{border-color:rgba(184,164,114,.4)}
.ai-input::placeholder{color:var(--text2)}
.ai-input:disabled{opacity:.5;cursor:not-allowed}
.ai-send-btn{background:var(--gold);border:none;color:#111;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;flex-shrink:0;transition:all .2s}
.ai-send-btn:hover{background:#cbb87f}
.ai-send-btn:disabled{opacity:.4;cursor:not-allowed}
.ai-send-btn .spinner{width:16px;height:16px;border:2px solid rgba(0,0,0,.2);border-top-color:#111;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Overlay backdrop */
.ai-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:999;opacity:0;pointer-events:none;transition:opacity .35s}
.ai-backdrop.show{opacity:1;pointer-events:auto}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login-wrap">
  <div class="login-box">
    <h1>Alpha CMS</h1>
    <p>Enter your admin password to continue.</p>
    <div id="login-error" class="login-error">Incorrect password</div>
    <input type="password" id="login-pass" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">Sign In</button>
  </div>
</div>

<!-- ADMIN -->
<div id="admin-screen" class="admin-layout hidden">
  <aside class="sidebar">
    <div class="sidebar-brand"><h2>Alpha CMS</h2><span>Content Manager</span></div>
    <nav class="sidebar-nav">
      <a href="#" data-panel="styles" class="active" onclick="showPanel('styles',this)">üé® Brand Styles</a>
      <a href="#" data-panel="layout" onclick="showPanel('layout',this)">üìê Layout & Order</a>
      <div class="divider"></div>
      <a href="#" data-panel="nav" onclick="showPanel('nav',this)">üîó Navigation</a>
      <a href="#" data-panel="hero" onclick="showPanel('hero',this)">üè† Hero</a>
      <a href="#" data-panel="features" onclick="showPanel('features',this)">‚ú® Features Strip</a>
      <a href="#" data-panel="about" onclick="showPanel('about',this)">üìñ About</a>
      <a href="#" data-panel="collections" onclick="showPanel('collections',this)">üóÇÔ∏è Collections</a>
      <a href="#" data-panel="product" onclick="showPanel('product',this)">üíé Product Detail</a>
      <a href="#" data-panel="advantage" onclick="showPanel('advantage',this)">‚ö° Advantage</a>
      <a href="#" data-panel="warranty" onclick="showPanel('warranty',this)">üõ°Ô∏è Warranty</a>
      <a href="#" data-panel="cta" onclick="showPanel('cta',this)">üì£ Call to Action</a>
      <a href="#" data-panel="footer" onclick="showPanel('footer',this)">üìã Footer</a>
      <div class="divider"></div>
      <button class="ai-trigger" onclick="toggleAIPanel()"><span class="pulse"></span> AI Assistant</button>
    </nav>
    <div class="sidebar-bottom"><a href="#" onclick="doLogout()">Sign Out</a></div>
  </aside>
  <main class="main">
    <div class="main-header">
      <h1 id="panel-title">Brand Styles</h1>
      <div class="save-bar">
        <span id="save-msg" class="save-msg">Saved!</span>
        <a href="/" target="_blank" class="btn btn-preview">Preview</a>
        <button class="btn btn-save" onclick="saveAll()">Save Changes</button>
      </div>
    </div>
    <div id="panels">

      <!-- STYLES -->
      <div id="panel-styles" class="panel active">
        <div class="field-row-3" id="color-fields"></div>
        <div class="field-row">
          <div class="field"><label>Serif Font Family</label><input type="text" data-bind="styles.fontSerif"></div>
          <div class="field"><label>Sans Font Family</label><input type="text" data-bind="styles.fontSans"></div>
        </div>
      </div>

      <!-- LAYOUT -->
      <div id="panel-layout" class="panel">
        <p style="font-size:.82rem;color:var(--text2);margin-bottom:20px">Drag sections to reorder. Toggle visibility on or off.</p>
        <ul id="section-order" class="order-list"></ul>
      </div>

      <!-- NAV -->
      <div id="panel-nav" class="panel">
        <div class="field-row">
          <div class="field"><label>Brand Name</label><input type="text" data-bind="nav.brand"></div>
          <div class="field"><label>Brand Subtitle</label><input type="text" data-bind="nav.brandSub"></div>
        </div>
        <h3 style="font-size:.88rem;margin:20px 0 12px">Navigation Links</h3>
        <div id="nav-links-list"></div>
      </div>

      <!-- HERO -->
      <div id="panel-hero" class="panel">
        <div class="field"><label>Badge Text</label><input type="text" data-bind="hero.badge"></div>
        <div class="field"><label>Heading (HTML allowed)</label><textarea data-bind="hero.heading" rows="2"></textarea></div>
        <div class="field"><label>Tagline</label><input type="text" data-bind="hero.tagline"></div>
        <div class="field"><label>Subtext</label><textarea data-bind="hero.subtext" rows="3"></textarea></div>
        <div class="field-row">
          <div class="field"><label>CTA Button Text</label><input type="text" data-bind="hero.ctaText"></div>
          <div class="field"><label>CTA Link</label><input type="text" data-bind="hero.ctaLink"></div>
        </div>
      </div>

      <!-- FEATURES -->
      <div id="panel-features" class="panel">
        <div id="features-list"></div>
      </div>

      <!-- ABOUT -->
      <div id="panel-about" class="panel">
        <div class="field"><label>Section Label</label><input type="text" data-bind="about.label"></div>
        <div class="field"><label>Visual Overlay Text</label><input type="text" data-bind="about.visualText"></div>
        <div class="field"><label>Heading</label><input type="text" data-bind="about.heading"></div>
        <div id="about-paragraphs"></div>
        <button class="btn-add" onclick="addAboutParagraph()">+ Add Paragraph</button>
        <div class="field" style="margin-top:20px"><label>Quote</label><textarea data-bind="about.quote" rows="3"></textarea></div>
        <div class="field"><label>Quote Author</label><input type="text" data-bind="about.quoteAuthor"></div>
      </div>

      <!-- COLLECTIONS -->
      <div id="panel-collections" class="panel">
        <div class="field"><label>Section Label</label><input type="text" data-bind="collections.label"></div>
        <div class="field"><label>Heading (HTML allowed)</label><textarea data-bind="collections.heading" rows="2"></textarea></div>
        <div class="field"><label>Subtext</label><textarea data-bind="collections.subtext" rows="2"></textarea></div>
        <h3 style="font-size:.88rem;margin:20px 0 12px">Collection Cards</h3>
        <div id="collections-list"></div>
        <button class="btn-add" onclick="addCollection()">+ Add Collection</button>
      </div>

      <!-- PRODUCT -->
      <div id="panel-product" class="panel">
        <div class="field"><label>Section Label</label><input type="text" data-bind="product.label"></div>
        <div class="field-row">
          <div class="field"><label>Product Name</label><input type="text" data-bind="product.name"></div>
          <div class="field"><label>Collection</label><input type="text" data-bind="product.collection"></div>
        </div>
        <div class="field"><label>Description</label><textarea data-bind="product.desc" rows="2"></textarea></div>
        <h3 style="font-size:.88rem;margin:20px 0 12px">Specifications</h3>
        <div id="product-specs"></div>
        <button class="btn-add" onclick="addSpec()">+ Add Spec</button>
        <div class="field" style="margin-top:20px"><label>Shield Badge Text</label><textarea data-bind="product.shieldText" rows="2"></textarea></div>
        <div class="field"><label>CTA Button Text</label><input type="text" data-bind="product.ctaText"></div>
      </div>

      <!-- ADVANTAGE -->
      <div id="panel-advantage" class="panel">
        <div class="field"><label>Section Label</label><input type="text" data-bind="advantage.label"></div>
        <div class="field"><label>Heading (HTML allowed)</label><textarea data-bind="advantage.heading" rows="2"></textarea></div>
        <div id="advantage-paragraphs"></div>
        <h3 style="font-size:.88rem;margin:20px 0 12px">Feature Cards</h3>
        <div id="advantage-cards"></div>
      </div>

      <!-- WARRANTY -->
      <div id="panel-warranty" class="panel">
        <div class="field"><label>Section Label</label><input type="text" data-bind="warranty.label"></div>
        <div class="field"><label>Heading (HTML allowed)</label><textarea data-bind="warranty.heading" rows="2"></textarea></div>
        <div class="field"><label>Subtext</label><textarea data-bind="warranty.subtext" rows="3"></textarea></div>
        <div id="warranty-cards"></div>
      </div>

      <!-- CTA -->
      <div id="panel-cta" class="panel">
        <div class="field"><label>Heading (HTML allowed)</label><textarea data-bind="cta.heading" rows="2"></textarea></div>
        <div class="field"><label>Subtext</label><textarea data-bind="cta.subtext" rows="3"></textarea></div>
        <div class="field-row">
          <div class="field"><label>Primary Button Text</label><input type="text" data-bind="cta.primaryBtn.text"></div>
          <div class="field"><label>Primary Button Link</label><input type="text" data-bind="cta.primaryBtn.link"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Secondary Button Text</label><input type="text" data-bind="cta.secondaryBtn.text"></div>
          <div class="field"><label>Secondary Button Link</label><input type="text" data-bind="cta.secondaryBtn.link"></div>
        </div>
      </div>

      <!-- FOOTER -->
      <div id="panel-footer" class="panel">
        <div class="field"><label>Description</label><textarea data-bind="footer.desc" rows="3"></textarea></div>
        <div class="field"><label>Copyright</label><input type="text" data-bind="footer.copyright"></div>
        <div class="field"><label>Legal Text</label><input type="text" data-bind="footer.legal"></div>
        <h3 style="font-size:.88rem;margin:20px 0 12px">Footer Columns</h3>
        <div id="footer-columns"></div>
      </div>

    </div>
  </main>
</div>

<!-- AI Panel Backdrop -->
<div id="ai-backdrop" class="ai-backdrop" onclick="closeAIPanel()"></div>

<!-- AI Panel -->
<div id="ai-panel" class="ai-panel">
  <div class="ai-panel-header">
    <h3><span class="ai-icon">‚ú¶</span> AI Content Manager</h3>
    <div class="ai-header-actions">
      <button class="ai-header-btn" onclick="toggleAIFullscreen()" title="Toggle fullscreen">‚§¢</button>
      <button class="ai-header-btn" onclick="closeAIPanel()" title="Close">‚úï</button>
    </div>
  </div>
  <div id="ai-messages" class="ai-messages">
    <div id="ai-empty" class="ai-empty">
      <div class="icon">‚ú¶</div>
      <h4>AI Content Manager</h4>
      <p>Ask me anything about your site, or tell me what you'd like to change.<br><br>I have full knowledge of your current content and can update any part of your site through natural conversation.</p>
      <div class="ai-prompts">
        <button class="ai-prompt-pill" onclick="usePrompt(this)">Rewrite the hero headline to be bolder</button>
        <button class="ai-prompt-pill" onclick="usePrompt(this)">Add a new collection and describe it</button>
        <button class="ai-prompt-pill" onclick="usePrompt(this)">Make the about section more personal</button>
        <button class="ai-prompt-pill" onclick="usePrompt(this)">Update the warranty card copy</button>
        <button class="ai-prompt-pill" onclick="usePrompt(this)">Create a tagline for the footer</button>
        <button class="ai-prompt-pill" onclick="usePrompt(this)">Suggest improvements to the CTA section</button>
      </div>
    </div>
  </div>
  <div class="ai-input-area">
    <div id="ai-attachments" class="ai-attachments-preview"></div>
    <div class="ai-input-row">
      <button class="ai-attach-btn" onclick="document.getElementById('ai-file-input').click()" title="Attach file">üìé</button>
      <input type="file" id="ai-file-input" multiple accept="image/*,application/pdf" style="display:none" onchange="handleAIFiles(this.files)">
      <textarea id="ai-input" class="ai-input" rows="1" placeholder="Ask me to change anything on the site..." onkeydown="handleAIKeydown(event)" oninput="autoResizeInput(this)"></textarea>
      <button id="ai-send" class="ai-send-btn" onclick="sendAIMessage()" title="Send">‚Üí</button>
    </div>
  </div>
</div>

<script>
let DATA = {};
const SECTION_LABELS = { hero:'Hero', features:'Features Strip', about:'About', collections:'Collections', product:'Product Detail', advantage:'Advantage', warranty:'Warranty', cta:'Call to Action' };
const COLOR_LABELS = { olive:'Olive (Primary)', oliveDark:'Olive Dark', cream:'Cream (Background)', creamDark:'Cream Dark', white:'White', charcoal:'Charcoal (Text)', warmGray:'Warm Gray', gold:'Gold (Accent)' };

// ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ
async function checkAuth() {
  const res = await fetch('/api/auth-check');
  const { authenticated } = await res.json();
  if (authenticated) { showAdmin(); } else { document.getElementById('login-screen').classList.remove('hidden'); }
}
async function doLogin() {
  const pass = document.getElementById('login-pass').value;
  const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass}) });
  if (res.ok) { showAdmin(); } else { document.getElementById('login-error').style.display='block'; }
}
async function doLogout() {
  await fetch('/api/logout', { method:'POST' });
  location.reload();
}
async function showAdmin() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('admin-screen').classList.remove('hidden');
  const res = await fetch('/api/content');
  DATA = await res.json();
  renderAll();
}

// ‚îÄ‚îÄ‚îÄ Save ‚îÄ‚îÄ‚îÄ
async function saveAll() {
  syncFromDOM();
  const res = await fetch('/api/content', { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(DATA) });
  if (res.ok) { const msg = document.getElementById('save-msg'); msg.classList.add('show'); setTimeout(() => msg.classList.remove('show'), 2000); }
}

// ‚îÄ‚îÄ‚îÄ Panel switch ‚îÄ‚îÄ‚îÄ
function showPanel(id, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  el?.classList.add('active');
  const titles = { styles:'Brand Styles', layout:'Layout & Order', nav:'Navigation', hero:'Hero', features:'Features Strip', about:'About', collections:'Collections', product:'Product Detail', advantage:'Advantage', warranty:'Warranty', cta:'Call to Action', footer:'Footer' };
  document.getElementById('panel-title').textContent = titles[id] || id;
  return false;
}

// ‚îÄ‚îÄ‚îÄ Deep get/set ‚îÄ‚îÄ‚îÄ
function deepGet(obj, path) { return path.split('.').reduce((o,k) => o?.[k], obj); }
function deepSet(obj, path, val) { const keys = path.split('.'); const last = keys.pop(); keys.reduce((o,k) => o[k] = o[k]||{}, obj)[last] = val; }

// ‚îÄ‚îÄ‚îÄ Sync DOM ‚Üí DATA ‚îÄ‚îÄ‚îÄ
function syncFromDOM() {
  document.querySelectorAll('[data-bind]').forEach(el => {
    deepSet(DATA, el.dataset.bind, el.value);
  });
  // Sync section order + visibility
  const items = document.querySelectorAll('#section-order .order-item');
  DATA.sectionOrder = [];
  items.forEach(item => {
    const key = item.dataset.section;
    DATA.sectionOrder.push(key);
    if (DATA[key]) DATA[key].visible = item.querySelector('.toggle')?.classList.contains('on') ?? true;
  });
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ
function renderAll() {
  // Bind simple fields
  document.querySelectorAll('[data-bind]').forEach(el => {
    const val = deepGet(DATA, el.dataset.bind);
    if (val !== undefined) el.value = val;
  });
  renderColorFields();
  renderSectionOrder();
  renderNavLinks();
  renderFeatures();
  renderAboutParagraphs();
  renderCollections();
  renderProductSpecs();
  renderAdvantageParagraphs();
  renderAdvantageCards();
  renderWarrantyCards();
  renderFooterColumns();
}

function renderColorFields() {
  const el = document.getElementById('color-fields');
  el.innerHTML = Object.entries(COLOR_LABELS).map(([key, label]) =>
    `<div class="field"><label>${label}</label><input type="color" data-bind="styles.${key}" value="${DATA.styles[key]}" oninput="deepSet(DATA,'styles.${key}',this.value)"></div>`
  ).join('');
}

function renderSectionOrder() {
  const el = document.getElementById('section-order');
  el.innerHTML = DATA.sectionOrder.map(key => {
    const vis = DATA[key]?.visible !== false;
    return `<li class="order-item" data-section="${key}" draggable="true">
      <span class="grip">‚†ø</span><span class="name">${SECTION_LABELS[key]||key}</span>
      <div class="toggle ${vis?'on':''}" onclick="this.classList.toggle('on')"></div>
    </li>`;
  }).join('');
  // Drag and drop
  let dragItem = null;
  el.querySelectorAll('.order-item').forEach(item => {
    item.addEventListener('dragstart', () => { dragItem = item; item.style.opacity = '.4'; });
    item.addEventListener('dragend', () => { dragItem = null; item.style.opacity = '1'; });
    item.addEventListener('dragover', e => { e.preventDefault(); });
    item.addEventListener('drop', e => {
      e.preventDefault();
      if (dragItem && dragItem !== item) { el.insertBefore(dragItem, item); }
    });
  });
}

function renderNavLinks() {
  const el = document.getElementById('nav-links-list');
  el.innerHTML = DATA.nav.links.map((l,i) => `
    <div class="card"><div class="card-header"><h3>Link ${i+1}</h3><div class="card-actions"><button class="btn-sm danger" onclick="DATA.nav.links.splice(${i},1);renderNavLinks()">Remove</button></div></div>
    <div class="field-row"><div class="field"><label>Label</label><input type="text" value="${l.label}" oninput="DATA.nav.links[${i}].label=this.value"></div><div class="field"><label>Href</label><input type="text" value="${l.href}" oninput="DATA.nav.links[${i}].href=this.value"></div></div></div>`).join('');
  el.innerHTML += `<button class="btn-add" onclick="DATA.nav.links.push({label:'New',href:'#'});renderNavLinks()">+ Add Link</button>`;
}

function renderFeatures() {
  const el = document.getElementById('features-list');
  el.innerHTML = DATA.features.items.map((f,i) => `
    <div class="card"><div class="card-header"><h3>${f.title}</h3><div class="card-actions"><button class="btn-sm danger" onclick="DATA.features.items.splice(${i},1);renderFeatures()">Remove</button></div></div>
    <div class="field"><label>Icon (check-circle, sun, layers, shield, tool, maximize)</label><input type="text" value="${f.icon}" oninput="DATA.features.items[${i}].icon=this.value"></div>
    <div class="field"><label>Title</label><input type="text" value="${f.title}" oninput="DATA.features.items[${i}].title=this.value"></div>
    <div class="field"><label>Text</label><textarea rows="2" oninput="DATA.features.items[${i}].text=this.value">${f.text}</textarea></div></div>`).join('');
  el.innerHTML += `<button class="btn-add" onclick="DATA.features.items.push({icon:'check-circle',title:'New Feature',text:'Description'});renderFeatures()">+ Add Feature</button>`;
}

function renderAboutParagraphs() {
  const el = document.getElementById('about-paragraphs');
  el.innerHTML = DATA.about.paragraphs.map((p,i) => `
    <div class="field" style="position:relative"><label>Paragraph ${i+1} <span style="cursor:pointer;color:var(--red)" onclick="DATA.about.paragraphs.splice(${i},1);renderAboutParagraphs()">‚úï remove</span></label>
    <textarea rows="3" oninput="DATA.about.paragraphs[${i}]=this.value">${p}</textarea></div>`).join('');
}
function addAboutParagraph() { DATA.about.paragraphs.push('New paragraph'); renderAboutParagraphs(); }

function renderCollections() {
  const el = document.getElementById('collections-list');
  el.innerHTML = DATA.collections.items.map((c,i) => `
    <div class="card"><div class="card-header"><h3>${c.name}</h3><div class="card-actions"><button class="btn-sm danger" onclick="DATA.collections.items.splice(${i},1);renderCollections()">Remove</button></div></div>
    <div class="field-row"><div class="field"><label>Tier Label</label><input type="text" value="${c.tier}" oninput="DATA.collections.items[${i}].tier=this.value"></div>
    <div class="field"><label>Name</label><input type="text" value="${c.name}" oninput="DATA.collections.items[${i}].name=this.value"></div></div>
    <div class="field"><label>Description</label><textarea rows="2" oninput="DATA.collections.items[${i}].desc=this.value">${c.desc}</textarea></div></div>`).join('');
}
function addCollection() { DATA.collections.items.push({tier:'New',name:'Collection',desc:'Description'}); renderCollections(); }

function renderProductSpecs() {
  const el = document.getElementById('product-specs');
  el.innerHTML = DATA.product.specs.map((s,i) => `
    <div class="card"><div class="field-row"><div class="field"><label>Label</label><input type="text" value="${s.label}" oninput="DATA.product.specs[${i}].label=this.value"></div>
    <div class="field"><label>Value</label><input type="text" value="${s.value}" oninput="DATA.product.specs[${i}].value=this.value"></div></div>
    <button class="btn-sm danger" style="margin-top:8px" onclick="DATA.product.specs.splice(${i},1);renderProductSpecs()">Remove</button></div>`).join('');
}
function addSpec() { DATA.product.specs.push({label:'New',value:'Value'}); renderProductSpecs(); }

function renderAdvantageParagraphs() {
  const el = document.getElementById('advantage-paragraphs');
  el.innerHTML = DATA.advantage.paragraphs.map((p,i) => `
    <div class="field"><label>Paragraph ${i+1}</label><textarea rows="3" oninput="DATA.advantage.paragraphs[${i}]=this.value">${p}</textarea></div>`).join('');
}

function renderAdvantageCards() {
  const el = document.getElementById('advantage-cards');
  el.innerHTML = DATA.advantage.cards.map((c,i) => `
    <div class="card"><div class="card-header"><h3>${c.title}</h3></div>
    <div class="field-row"><div class="field"><label>Icon</label><input type="text" value="${c.icon}" oninput="DATA.advantage.cards[${i}].icon=this.value"></div>
    <div class="field"><label>Title</label><input type="text" value="${c.title}" oninput="DATA.advantage.cards[${i}].title=this.value"></div></div>
    <div class="field"><label>Text</label><textarea rows="2" oninput="DATA.advantage.cards[${i}].text=this.value">${c.text}</textarea></div></div>`).join('');
}

function renderWarrantyCards() {
  const el = document.getElementById('warranty-cards');
  el.innerHTML = DATA.warranty.cards.map((c,i) => `
    <div class="card"><div class="field-row-3"><div class="field"><label>Number</label><input type="text" value="${c.number}" oninput="DATA.warranty.cards[${i}].number=this.value"></div>
    <div class="field"><label>Title</label><input type="text" value="${c.title}" oninput="DATA.warranty.cards[${i}].title=this.value"></div>
    <div class="field"><label>Text</label><input type="text" value="${c.text}" oninput="DATA.warranty.cards[${i}].text=this.value"></div></div></div>`).join('');
}

function renderFooterColumns() {
  const el = document.getElementById('footer-columns');
  el.innerHTML = DATA.footer.columns.map((col,ci) => `
    <div class="card"><div class="card-header"><h3>${col.title}</h3></div>
    <div class="field"><label>Column Title</label><input type="text" value="${col.title}" oninput="DATA.footer.columns[${ci}].title=this.value"></div>
    ${col.links.map((l,li) => `<div class="field-row"><div class="field"><label>Label</label><input type="text" value="${l.label}" oninput="DATA.footer.columns[${ci}].links[${li}].label=this.value"></div>
    <div class="field"><label>Href</label><input type="text" value="${l.href}" oninput="DATA.footer.columns[${ci}].links[${li}].href=this.value"></div></div>`).join('')}
    <button class="btn-add" onclick="DATA.footer.columns[${ci}].links.push({label:'New',href:'#'});renderFooterColumns()">+ Add Link</button></div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ AI Assistant ‚îÄ‚îÄ‚îÄ
const aiPanel = document.getElementById('ai-panel');
const aiBackdrop = document.getElementById('ai-backdrop');
const aiMessages = document.getElementById('ai-messages');
const aiInput = document.getElementById('ai-input');
const aiSend = document.getElementById('ai-send');
const aiEmpty = document.getElementById('ai-empty');
const aiAttachments = document.getElementById('ai-attachments');
const aiFileInput = document.getElementById('ai-file-input');

let aiConversation = []; // {role, content} pairs for API
let aiAttachedFiles = []; // {type, base64, mimeType, name, previewUrl}
let aiIsLoading = false;

// Restore session from sessionStorage
(function restoreAISession() {
  try {
    const saved = sessionStorage.getItem('ai_conversation');
    const savedHtml = sessionStorage.getItem('ai_messages_html');
    if (saved) {
      aiConversation = JSON.parse(saved);
      if (savedHtml && aiConversation.length > 0) {
        aiEmpty.style.display = 'none';
        aiMessages.innerHTML = savedHtml;
      }
    }
  } catch {}
})();

function saveAISession() {
  try {
    sessionStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
    sessionStorage.setItem('ai_messages_html', aiMessages.innerHTML);
  } catch {}
}

function toggleAIPanel() {
  aiPanel.classList.toggle('open');
  aiBackdrop.classList.toggle('show');
  if (aiPanel.classList.contains('open')) {
    aiInput.focus();
    scrollAIToBottom();
  }
}

function closeAIPanel() {
  aiPanel.classList.remove('open');
  aiBackdrop.classList.remove('show');
}

function toggleAIFullscreen() {
  aiPanel.classList.toggle('fullscreen');
}

function usePrompt(el) {
  aiInput.value = el.textContent;
  aiInput.focus();
  autoResizeInput(aiInput);
}

function handleAIKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendAIMessage();
  }
}

function autoResizeInput(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function formatTime() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Simple markdown ‚Üí HTML (bold, italic, code, lists)
function renderMarkdown(text) {
  let html = text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>');
  // Split into paragraphs
  const lines = html.split('\n');
  let result = '';
  let inList = false;
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed.match(/^[-‚Ä¢]\s/)) {
      if (!inList) { result += '<ul>'; inList = true; }
      result += '<li>' + trimmed.replace(/^[-‚Ä¢]\s/, '') + '</li>';
    } else if (trimmed.match(/^\d+\.\s/)) {
      if (!inList) { result += '<ol>'; inList = true; }
      result += '<li>' + trimmed.replace(/^\d+\.\s/, '') + '</li>';
    } else {
      if (inList) { result += inList ? '</ul>' : '</ol>'; inList = false; }
      if (trimmed) result += '<p>' + trimmed + '</p>';
    }
  }
  if (inList) result += '</ul>';
  return result || '<p>' + text + '</p>';
}

function scrollAIToBottom() {
  setTimeout(() => { aiMessages.scrollTop = aiMessages.scrollHeight; }, 50);
}

// File attachments
function handleAIFiles(files) {
  for (const file of files) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const base64Full = e.target.result;
      const base64Data = base64Full.split(',')[1];
      const isImage = file.type.startsWith('image/');
      aiAttachedFiles.push({
        type: isImage ? 'image' : 'pdf',
        base64: base64Data,
        mimeType: file.type,
        name: file.name,
        previewUrl: isImage ? base64Full : null,
      });
      renderAttachmentPreviews();
    };
    reader.readAsDataURL(file);
  }
  aiFileInput.value = '';
}

function renderAttachmentPreviews() {
  aiAttachments.innerHTML = aiAttachedFiles.map((f, i) => {
    if (f.type === 'image') {
      return `<div class="ai-attachment-item"><img src="${f.previewUrl}" alt="${f.name}"><button class="ai-att-remove" onclick="removeAttachment(${i})">‚úï</button></div>`;
    }
    return `<div class="ai-attachment-item"><span style="font-size:1.2rem">üìÑ</span><span class="ai-att-name">${f.name}</span><button class="ai-att-remove" onclick="removeAttachment(${i})">‚úï</button></div>`;
  }).join('');
}

function removeAttachment(idx) {
  aiAttachedFiles.splice(idx, 1);
  renderAttachmentPreviews();
}

// Drag and drop on the panel
aiPanel.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); });
aiPanel.addEventListener('drop', (e) => {
  e.preventDefault(); e.stopPropagation();
  if (e.dataTransfer.files.length) handleAIFiles(e.dataTransfer.files);
});

// Send message
async function sendAIMessage() {
  const text = aiInput.value.trim();
  if (!text || aiIsLoading) return;

  // Hide empty state
  aiEmpty.style.display = 'none';

  // Build attachment HTML for user message
  let attachmentHtml = '';
  const currentAttachments = [...aiAttachedFiles];
  for (const att of currentAttachments) {
    if (att.type === 'image') {
      attachmentHtml += `<img class="ai-attachment-thumb" src="${att.previewUrl}" alt="${att.name}">`;
    } else {
      attachmentHtml += `<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:.78rem;color:var(--text2)">üìÑ ${att.name}</div>`;
    }
  }

  // Add user message to UI
  const userMsgHtml = `<div class="ai-msg ai-msg-user"><div class="ai-bubble">${attachmentHtml}${escapeHtml(text)}</div><div class="ai-time">${formatTime()}</div></div>`;
  aiMessages.insertAdjacentHTML('beforeend', userMsgHtml);

  // Add to conversation
  aiConversation.push({ role: 'user', content: text });

  // Clear input
  aiInput.value = '';
  aiInput.style.height = 'auto';
  aiAttachedFiles = [];
  renderAttachmentPreviews();

  // Show typing indicator
  setAILoading(true);
  scrollAIToBottom();

  try {
    const payload = {
      messages: aiConversation,
      attachments: currentAttachments.filter(a => a.type === 'image').map(a => ({
        type: 'image', base64: a.base64, mimeType: a.mimeType,
      })),
    };

    const res = await fetch('/api/ai/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      throw new Error(errData.error || 'Request failed');
    }

    const data = await res.json();
    setAILoading(false);

    // Add assistant reply to conversation
    aiConversation.push({ role: 'assistant', content: data.reply });

    // Build assistant message HTML
    let assistantHtml = `<div class="ai-msg ai-msg-assistant"><div class="ai-label">Claude</div><div class="ai-bubble">${renderMarkdown(data.reply)}</div>`;

    // Add diff card if changes proposed
    if (data.diff && data.proposedContent) {
      const diffId = 'diff-' + Date.now();
      let diffFieldsHtml = '';
      for (const [fieldPath, change] of Object.entries(data.diff)) {
        diffFieldsHtml += `<div class="ai-diff-field"><div class="ai-diff-field-name">${escapeHtml(fieldPath)}</div><div class="ai-diff-remove">‚àí ${escapeHtml(change.before)}</div><div class="ai-diff-add">+ ${escapeHtml(change.after)}</div></div>`;
      }
      assistantHtml += `<div class="ai-diff-card" id="${diffId}"><div class="ai-diff-header">Proposed Changes</div>${diffFieldsHtml}<div class="ai-diff-actions"><button class="ai-diff-apply" onclick="applyAIChanges('${diffId}', this)">‚úì Apply Changes</button><button class="ai-diff-discard" onclick="discardAIChanges('${diffId}')">‚úó Discard</button></div></div>`;
      // Store proposedContent on the card
      setTimeout(() => {
        const card = document.getElementById(diffId);
        if (card) card._proposedContent = data.proposedContent;
      }, 0);
    }

    assistantHtml += `<div class="ai-time">${formatTime()}</div></div>`;
    aiMessages.insertAdjacentHTML('beforeend', assistantHtml);
    scrollAIToBottom();
    saveAISession();

  } catch (err) {
    setAILoading(false);
    const errorHtml = `<div class="ai-msg ai-msg-assistant"><div class="ai-label">Claude</div><div class="ai-bubble" style="border-left:2px solid var(--red);padding-left:12px"><p style="color:#ff6b6b">Something went wrong ‚Äî ${escapeHtml(err.message)}. Please try again.</p></div></div>`;
    aiMessages.insertAdjacentHTML('beforeend', errorHtml);
    // Remove the failed user message from conversation so they can retry
    aiConversation.pop();
    scrollAIToBottom();
  }
}

function setAILoading(loading) {
  aiIsLoading = loading;
  aiInput.disabled = loading;
  aiSend.disabled = loading;
  const typingId = 'ai-typing-indicator';
  if (loading) {
    aiSend.innerHTML = '<div class="spinner"></div>';
    const typingHtml = `<div class="ai-typing" id="${typingId}"><div class="ai-label">Claude</div><div class="ai-typing-dots"><span></span><span></span><span></span></div></div>`;
    aiMessages.insertAdjacentHTML('beforeend', typingHtml);
    scrollAIToBottom();
  } else {
    aiSend.innerHTML = '‚Üí';
    const typing = document.getElementById(typingId);
    if (typing) typing.remove();
  }
}

async function applyAIChanges(diffId, btn) {
  const card = document.getElementById(diffId);
  if (!card || !card._proposedContent) return;

  btn.disabled = true;
  btn.textContent = 'Applying...';

  try {
    const res = await fetch('/api/ai/apply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ proposedContent: card._proposedContent }),
    });
    if (!res.ok) throw new Error('Apply failed');

    // Update local DATA so admin panel reflects changes
    DATA = card._proposedContent;
    renderAll();

    // Collapse card to applied state
    card.classList.add('collapsed');
    card.innerHTML = `<div class="ai-diff-applied">‚úì Applied</div><span class="ai-diff-undo-link" onclick="undoAIChanges('${diffId}')">Undo</span>`;

    // Add system message
    addAISystemMessage('Changes applied ‚úì');
    saveAISession();

  } catch (err) {
    btn.disabled = false;
    btn.textContent = '‚úì Apply Changes';
    addAISystemMessage('Failed to apply changes ‚Äî please try again');
  }
}

function discardAIChanges(diffId) {
  const card = document.getElementById(diffId);
  if (!card) return;
  card.remove();
  addAISystemMessage('Changes discarded');
  saveAISession();
}

async function undoAIChanges(diffId) {
  try {
    const res = await fetch('/api/ai/undo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });
    if (!res.ok) throw new Error('Undo failed');
    const data = await res.json();

    // Reload content into admin
    const contentRes = await fetch('/api/content');
    DATA = await contentRes.json();
    renderAll();

    // Update the card
    const card = document.getElementById(diffId);
    if (card) {
      card.innerHTML = '<div style="font-size:.78rem;color:var(--text2)">Reverted</div>';
    }

    addAISystemMessage('Reverted to previous version');
    saveAISession();
  } catch {
    addAISystemMessage('Failed to undo ‚Äî please try again');
  }
}

function addAISystemMessage(text) {
  const html = `<div class="ai-msg-system"><span>${escapeHtml(text)}</span></div>`;
  aiMessages.insertAdjacentHTML('beforeend', html);
  scrollAIToBottom();
}

function escapeHtml(str) {
  if (str == null) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

checkAuth();
</script>
</body>
</html>
